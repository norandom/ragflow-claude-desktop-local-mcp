name: TruffleHog Secrets Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  trufflehog:
    runs-on: ubuntu-latest
    name: TruffleHog Secrets Scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: TruffleHog Enterprise (with custom detectors for AI API keys)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: |
            --debug
            --only-verified
            --detector-keywords "openai,anthropic,claude,gpt,api_key,apikey,secret,token,bearer"
            --exclude-paths .git
            --exclude-paths node_modules
            --exclude-paths .env.example
            --exclude-paths "*.md"
            --json
        continue-on-error: true
        id: trufflehog_detailed

      - name: Process TruffleHog Results
        if: always()
        run: |
          echo "Scan completed. Check the logs above for any detected secrets."
          echo "If secrets are found, the workflow will fail to prevent the push/merge."
          
      - name: Comment PR on failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Security Alert**: Potential secrets detected in this PR. Please review the TruffleHog scan results and remove any exposed credentials before merging.'
            })